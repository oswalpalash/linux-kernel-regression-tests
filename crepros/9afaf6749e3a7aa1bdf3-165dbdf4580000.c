// https://syzkaller.appspot.com/bug?id=fde520311d6318a3707c815e1f10140fe8862e1a
// autogenerated by syzkaller (https://github.com/google/syzkaller)

#define _GNU_SOURCE

#include <dirent.h>
#include <endian.h>
#include <errno.h>
#include <fcntl.h>
#include <signal.h>
#include <stdarg.h>
#include <stdbool.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/prctl.h>
#include <sys/stat.h>
#include <sys/syscall.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <time.h>
#include <unistd.h>

#ifndef __NR_futex_wake
#define __NR_futex_wake 454
#endif

static void sleep_ms(uint64_t ms)
{
  usleep(ms * 1000);
}

static uint64_t current_time_ms(void)
{
  struct timespec ts;
  if (clock_gettime(CLOCK_MONOTONIC, &ts))
    exit(1);
  return (uint64_t)ts.tv_sec * 1000 + (uint64_t)ts.tv_nsec / 1000000;
}

static bool write_file(const char* file, const char* what, ...)
{
  char buf[1024];
  va_list args;
  va_start(args, what);
  vsnprintf(buf, sizeof(buf), what, args);
  va_end(args);
  buf[sizeof(buf) - 1] = 0;
  int len = strlen(buf);
  int fd = open(file, O_WRONLY | O_CLOEXEC);
  if (fd == -1)
    return false;
  if (write(fd, buf, len) != len) {
    int err = errno;
    close(fd);
    errno = err;
    return false;
  }
  close(fd);
  return true;
}

static void kill_and_wait(int pid, int* status)
{
  kill(-pid, SIGKILL);
  kill(pid, SIGKILL);
  for (int i = 0; i < 100; i++) {
    if (waitpid(-1, status, WNOHANG | __WALL) == pid)
      return;
    usleep(1000);
  }
  DIR* dir = opendir("/sys/fs/fuse/connections");
  if (dir) {
    for (;;) {
      struct dirent* ent = readdir(dir);
      if (!ent)
        break;
      if (strcmp(ent->d_name, ".") == 0 || strcmp(ent->d_name, "..") == 0)
        continue;
      char abort[300];
      snprintf(abort, sizeof(abort), "/sys/fs/fuse/connections/%s/abort",
               ent->d_name);
      int fd = open(abort, O_WRONLY);
      if (fd == -1) {
        continue;
      }
      if (write(fd, abort, 1) < 0) {
      }
      close(fd);
    }
    closedir(dir);
  } else {
  }
  while (waitpid(-1, status, __WALL) != pid) {
  }
}

static void setup_test()
{
  prctl(PR_SET_PDEATHSIG, SIGKILL, 0, 0, 0);
  setpgrp();
  write_file("/proc/self/oom_score_adj", "1000");
}

static void execute_one(void);

#define WAIT_FLAGS __WALL

static void loop(void)
{
  int iter = 0;
  for (;; iter++) {
    int pid = fork();
    if (pid < 0)
      exit(1);
    if (pid == 0) {
      setup_test();
      execute_one();
      exit(0);
    }
    int status = 0;
    uint64_t start = current_time_ms();
    for (;;) {
      sleep_ms(10);
      if (waitpid(-1, &status, WNOHANG | WAIT_FLAGS) == pid)
        break;
      if (current_time_ms() - start < 5000)
        continue;
      kill_and_wait(pid, &status);
      break;
    }
  }
}

void execute_one(void)
{
  if (write(1, "executing program\n", sizeof("executing program\n") - 1)) {
  }
  *(uint32_t*)0x200000000200 = 0xc6d;
  *(uint32_t*)0x200000000204 = 0xee01;
  *(uint32_t*)0x200000000208 = 0xee01;
  *(uint32_t*)0x20000000020c = 0;
  *(uint32_t*)0x200000000210 = 3;
  *(uint32_t*)0x200000000214 = 0x40;
  *(uint16_t*)0x200000000218 = 3;
  *(uint32_t*)0x20000000021c = 5;
  *(uint64_t*)0x200000000220 = 0xf;
  *(uint64_t*)0x200000000228 = 1;
  *(uint64_t*)0x200000000230 = 0;
  *(uint32_t*)0x200000000238 = -1;
  *(uint32_t*)0x20000000023c = 0;
  *(uint16_t*)0x200000000240 = 5;
  *(uint16_t*)0x200000000242 = 0;
  *(uint64_t*)0x200000000248 = 0;
  *(uint64_t*)0x200000000250 = 0x200000000100;
  memcpy(
      (void*)0x200000000100,
      "\x1c\xb8\x5f\xb8\x73\xe9\x46\x29\x2f\x68\x23\x82\xac\x34\x03\x19\xd2\xee"
      "\x14\x27\x40\xbe\xba\xa2\xce\x77\x40\xee\xe6\x67\x38\x89\x18\x20\x0b\x26"
      "\x41\xdf\x6d\xcc\x42\x38\x0e\x1b\xa5\xaf\x5c\x8a\x03\x8b\xf1\xf0\x58\xd7"
      "\xbc\x9a\x7d\x65\x41\x06\xc8\x76\x5a\xbf\x45\x7d\xbb\xf8\x64\x9f\x29\x88"
      "\xd5\xc0\xfd\x11\xf2\xb3\x53\xa3\x1b\xfa\x5b\xd8\x54\x41\x03\xc7\xb7\x61"
      "\x39\x00\xc5\xaf\x97\xb8\x78\xb9\xaf\xd4\xe7\xed\xd3\xb8\xea\xbc\x33\xad"
      "\x64\x46\xfa\x8d\x79\x21\xba\xba\xe3\x41\x7e\xef\x3a\x5a\xb6\x14\xc3\x97"
      "\x41\xab\x4e\xdd\x9f\x50\xf4\x72\x93\x8f\x49\x48\xa9\x2b\x1a\x51\x1c\x52"
      "\x63\xa5\xf9\x5d\xcb\x93\xe5\xfd\xf8\xb0\xac\xd2\x1e\xc5\xf5\xe4\x01\xa1"
      "\xf1\xd6\x42\x35\x0a\x50\xc9\xdc\xa0\x3b\x37\x3b\x6f\x89\x90\x59\xf7\x74"
      "\x8a\x26\x29\x83\x52\x72\x85\x68\x2a\xa8\x16\xe7\xa2\xfa\x83\xf4\xc8\x13"
      "\xa4\x4a\x1f\xaa\x74\xed\x28\x9a\xab\x0c\xdf\x27\xab\xe5\xa1\x74\xe5\xbe"
      "\xbe\xe0\x36\xa5\x71\xc7\x7d\xd2\xb0\x9c\x5c\x4d\x27\x6f\x6f\x2b\x41\x13"
      "\x89\xf0\x43\x5f\x01\x29\xb5\x74\x7e\xce\x5a\x28\xb3\x30",
      248);
  syscall(__NR_shmctl, /*shmid=*/0xb1e, /*cmd=*/0xcul,
          /*buf=*/0x200000000200ul);
  syscall(__NR_futex_wake, /*uaddr=*/0x200000000140ul, /*mask=*/8ul, /*nr=*/6,
          /*flags=*/6);
}
int main(void)
{
  syscall(__NR_mmap, /*addr=*/0x1ffffffff000ul, /*len=*/0x1000ul, /*prot=*/0ul,
          /*flags=MAP_FIXED|MAP_ANONYMOUS|MAP_PRIVATE*/ 0x32ul,
          /*fd=*/(intptr_t)-1, /*offset=*/0ul);
  syscall(__NR_mmap, /*addr=*/0x200000000000ul, /*len=*/0x1000000ul,
          /*prot=PROT_WRITE|PROT_READ|PROT_EXEC*/ 7ul,
          /*flags=MAP_FIXED|MAP_ANONYMOUS|MAP_PRIVATE*/ 0x32ul,
          /*fd=*/(intptr_t)-1, /*offset=*/0ul);
  syscall(__NR_mmap, /*addr=*/0x200001000000ul, /*len=*/0x1000ul, /*prot=*/0ul,
          /*flags=MAP_FIXED|MAP_ANONYMOUS|MAP_PRIVATE*/ 0x32ul,
          /*fd=*/(intptr_t)-1, /*offset=*/0ul);
  const char* reason;
  (void)reason;
  loop();
  return 0;
}
